package main

import (
	"database/sql"

	"github.com/pgvector/pgvector-go"
)

// retrieveSimilarCVEDescriptions retrieves similar CVEs based on the embedding
func retrieveSimilarCVEDescriptions(db *sql.DB, embedding []float32) ([]string, error) {
	// Set search path
	_, err := db.Exec("SET search_path TO cve")
	if err != nil {
		return nil, err
	}

	// Main query
	query := `
	SELECT cve_id, description 
	FROM cve_records 
	WHERE embedding IS NOT NULL
	ORDER BY embedding <-> $1
	LIMIT 5;`

	rows, err := db.Query(query, pgvector.NewVector(embedding))
	if err != nil {
		return nil, err
	}
	defer rows.Close()

	var similarCves []string
	for rows.Next() {
		var cveID string
		var description string
		if err := rows.Scan(&cveID, &description); err != nil {
			return nil, err
		}
		similarCves = append(similarCves, cveID+description)
	}

	if err := rows.Err(); err != nil {
		return nil, err
	}

	return similarCves, nil
}
